# This is a GitHub Actions workflow file.
# It will automatically run your Python script on a schedule.

name: Scrape Gabba Events

on:
  # Run this workflow every day at 8:00 AM UTC (which is 6:00 PM AEST)
  schedule:
    - cron: '0 8 * * *'
  
  # Allows you to run this workflow manually from the Actions tab on GitHub
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # This explicitly gives the job permission to write to the repository,
    # which is required for the 'git push' step.
    permissions:
      contents: write

    steps:
      - name: 1. Check out repository
        uses: actions/checkout@v4

      - name: 2. Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' 

      - name: 3. Set up Chrome (for Selenium)
        uses: browser-actions/setup-chrome@v1
        
      - name: 4. Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # Use the github.workspace variable to find the requirements file
          pip install -r ${{ github.workspace }}/requirements.txt

      - name: 5. Run the scraper
        run: |
          # Use the github.workspace variable to find the python script
          python ${{ github.workspace }}/gabba_event_scraper.py

      - name: 6. Commit and push the updated .ics file
        run: |
          # We must set the working directory for git to find the file
          cd ${{ github.workspace }}
          
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          # Add the generated file
          git add gabba-events.ics
          
          # Check if there are any changes staged (i.e., if the ics file is new or changed)
          # This is the new, corrected command.
          if git diff-index --quiet --cached HEAD --; then
            echo "No changes to commit. The .ics file is already up-to-date."
          else
            echo "Changes detected. Committing and pushing..."
            git commit -m "Update Gabba events calendar"
            git push
          fi
